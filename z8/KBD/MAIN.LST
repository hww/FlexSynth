Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    1


main.s

Location Object              Type  Line Source
                             A        1 	GLOBALS	ON
                             A        2 
                   00000000  A        3 TEST	EQU	0
                   00000000  A        4 TESTK	EQU	0
                             A        5 
                             A        6 	INCLUDE "INI.S"
                             B        1 ; MAIN
                             B        2 ; HEADER
                             B        3 ; *******************************************************************
                             B        4 ;	  
                             B        5 ; *******************************************************************
                             B        6 
                             B        7 	DEFINE	IDATA , SPACE = RFILE , ORG = 0H
                             B        8 	DEFINE	ICODE , SPACE = ROM , ORG = 0H
                             B        9 
                             B       10 ; *******************************************************************
                             B       11 ;	    	 
                             B       12 ; *******************************************************************
                             B       13 
                             B       14 	SEGMENT	ICODE
                             B       15 	ORG	0000H
00000000 00 44               B       16 	DW	DUMMY	;P3.2 ( )
00000002 00 44               B       17 	DW	DUMMY	;P3.3 REF ( )
00000004 00 44               B       18 	DW	DUMMY	;P3.1   ADC ( )
00000006 02 6B               B       19 	DW	INT3	;P3.0   ( )
00000008 02 B8               B       20 	DW	T0_INT	;T0  
0000000A 00 44               B       21 	DW	DUMMY	;T1 ( )
                             B       22 ; *******************************************************************
                             B       23 	ORG	%0C
                             B       24 ; *******************************************************************
                             B       25 ;	 
                   00000000  B       26 RG_SCC	EQU	%0
                   00000010  B       27 RG_MAIN	EQU	%10
                             B       28 ; *******************************************************************
                             B       29 ;	 
                             B       30 ;
                   000000EF  B       31 SP_MAIN	EQU	%EF
                             B       32 ; *******************************************************************
                             B       33 ;	 
                             B       34 ; *******************************************************************
0000000C                     B       35 START:
0000000C 8F                  B       36 	DI
                             B       37 ; *******************************************************************
                             B       38 ;  
                             B       39 ; *******************************************************************
0000000D E6 FD 0F            B       40 	LD	RP,#0FH
00000010 E6 0B 02            B       41 	LD	0BH,#2	; CLK=XTAL
00000013 E6 FD 00            B       42 	LD	RP,#0H
                             B       43 ; -------------------------------------------------------------------
00000016 E6 F9 01            B       44 	LD	IPR,#1	;INT. PRIORITY
                             B       45 ; -------------------------------------------------------------------
                             B       46 ;    
00000019 E6 F8 45            B       47 	LD	P01M,#01000101B ;P0-INPUT, P1-OUTPUT, INTERNAL STACK
0000001C E6 F6 80            B       48 	LD	P2M, #10000000B ;P2.7-INPUT OTHER-OUTPUT
0000001F E6 F7 03            B       49 	LD	P3M, #00000011B ;P3-ANALOG MODE P2-OPEN DRAIN
00000022 E6 01 7F            B       50 	LD	P1,#07FH	; RESET = 0
00000025 E6 02 FF            B       51 	LD	P2,#0FFH
00000028 FF                  B       52 	NOP			;  RESET
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    2


INI.S

Location Object              Type  Line Source
00000029 FF                  B       53 	NOP
0000002A FF                  B       54 	NOP
0000002B FF                  B       55 	NOP
0000002C FF                  B       56 	NOP
0000002D 46 01 80            B       57 	OR	P1,#80H		;RESET= 1
                             B       58 ; -------------------------------------------------------------------
00000030 E6 FD 00            B       59 	LD	RP,#RG_SCC	;  
00000033 B0 FE               B       60 	CLR	SPH
00000035 E6 FF EF            B       61 	LD	SPL,#SP_MAIN 	; 
00000038 D6 00 45            B       62 	CALL	MAININIT
0000003B E6 FD 10            B       63 	LD	RP,#RG_MAIN
0000003E                     B       64 DIE:
0000003E 9F                  B       65 	EI			;  
0000003F D6 02 F0            B       66 	CALL	SRCH2SEND
00000042 8B FA               B       67 	JR	DIE
                             B       68 ; *******************************************************************
                             B       69 ;	  
                             B       70 ; *******************************************************************
00000044 BF                  B       71 DUMMY:	IRET
                             B       72 ; *******************************************************************
                             B       73 ;  
                             B       74 ; *******************************************************************
00000045                     B       75 MAININIT:
00000045 8F                  B       76 	DI
                             B       77 	SCOPE
00000046 D6 02 72            B       78 	CALL	SER_INIT
00000049 D6 01 C4            B       79 	CALL	ADC3_INIT
0000004C D6 00 50            B       80 	CALL	SCANER_INIT
0000004F AF                  B       81 	RET
                             B       82 ; *******************************************************************
                             B       83 ; *******************************************************************
                             A        7 	INCLUDE "SCANER.S"
                             B        1 ; SCANER
                             B        2 ; HEADER
                             B        3 ; *******************************************************************
                             B        4 ;    
                             B        5 ; *******************************************************************
                   R0        B        6 PR0	EQU	R0
                   R1        B        7 PR1	EQU	R1
                   R2        B        8 PR2	EQU	R2
                             B        9 ; -------------------------------------------------------------------
                             B       10 	SEGMENT	IDATA
                             B       11 	ORG	20H
                             B       12 
                   0000000A  B       13 FIFO_S	EQU	10	;  
00000020                     B       14 NUM	DS	FIFO_S	;  
0000002A                     B       15 TIME	DS	FIFO_S	;  
00000034                     B       16 FLAG_S	DS	FIFO_S	;  
0000003E                     B       17 FREE	DS	1
0000003F                     B       18 	DS	1	;  
                             B       19 
00000040                     B       20 DBASE	DS	49	;    1 
00000071                     B       21 MX1	DS	7	;   1
00000078                     B       22 MX2	DS	7	;   2
                             B       23 ; -------------------------------------------------------------------
0000007F                     B       24 LINE	DS	1
00000080                     B       25 MASK	DS	1
                             B       26 ; *******************************************************************
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    3


SCANER.S

Location Object              Type  Line Source
                             B       27 ;	    
                             B       28 ; *******************************************************************
                             B       29 	SEGMENT	ICODE
                             B       30 
00000050                     B       31 SCANER_INIT:
                             B       32 	SCOPE
00000050 4C 31               B       33 	LD	R4,#49 
00000052 B0 E5               B       34 	CLR	R5
00000054                     B       35 $LOOP:
00000054 D7 54 3F            B       36 	LD	DBASE-1(R4),R5	;   
00000057 4A FB               B       37 	DJNZ	R4,$LOOP
                             B       38 
                             B       39 	SCOPE
00000059 4C 07               B       40 	LD	R4,#7
0000005B                     B       41 $LOOP:
0000005B D7 54 70            B       42 	LD	MX1-1(R4),R5
0000005E D7 54 77            B       43 	LD	MX2-1(R4),R5	;   
00000061 4A F8               B       44 	DJNZ	R4,$LOOP
                             B       45 
                             B       46 	SCOPE
00000063 4C 0A               B       47 	LD	R4,#FIFO_S	;  
00000065 6C 80               B       48 	LD	R6,#80H
00000067                     B       49 $LOOP:
00000067 D7 54 1F            B       50 	LD	NUM-1(R4),R5
0000006A D7 64 29            B       51 	LD	TIME-1(R4),R6	;  
0000006D D7 44 33            B       52 	LD	FLAG_S-1(R4),R4	;     
00000070 4A F5               B       53 	DJNZ	R4,$LOOP
                             B       54 
00000072 B0 3E               B       55 	CLR	FREE		;      = 0
00000074 B0 7F               B       56 	CLR	LINE		;   = 0
00000076 E6 80 FE            B       57 	LD	MASK,#0FEH	;   = FEH
00000079 AF                  B       58 	RET
                             B       59 
                             B       60 ; *******************************************************************
                             B       61 ; C    
                             B       62 ; *******************************************************************
                             B       63 
0000007A                     B       64 SCANER:
                             B       65 	SCOPE
0000007A D6 01 47            B       66 	CALL	SCAN_MATRIX	; R4-R5= NEW1-NEW2
0000007D 60 E4               B       67 	COM	R4
0000007F 60 E5               B       68 	COM	R5
00000081 88 7F               B       69 	LD	R8,LINE	;  
00000083 C7 68 71            B       70 	LD	R6,MX1(R8)	;  
00000086 C7 78 78            B       71 	LD	R7,MX2(R8)	;  2
                             B       72 
                             B       73 	IF	TESTK
                             B       74 		LD	R4,R6
                             B       75 		LD	R5,R7
                             B       76 		COM	R4
                             B       77 		COM	R5
                             B       78 	ENDIF
                             B       79 
00000089 D7 48 71            B       80 	LD	MX1(R8),R4
0000008C D7 58 78            B       81 	LD	MX2(R8),R5	;   
                             B       82 			; R4-R5  
                             B       83 			; R6-R7  
0000008F B2 64               B       84 	XOR	R6,R4
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    4


SCANER.S

Location Object              Type  Line Source
00000091 B2 75               B       85 	XOR	R7,R5	; R6-R7 
                             B       86 
00000093 F0 E8               B       87 	SWAP	R8	;     
00000095 E0 E8               B       88 	RR	R8
00000097 00 E8               B       89 	DEC	R8	;   - 1
00000099 70 E8               B       90 	PUSH	R8
                             B       91 ; -------------------------------------------------------------------
0000009B                     B       92 $LOOP:
0000009B 8E                  B       93 	INC	R8	;  + 1
0000009C E0 E4               B       94 	RR	R4	;   
0000009E CF                  B       95 	RCF
0000009F C0 E6               B       96 	RRC	R6
000000A1 7B 06               B       97 	JR	C,$CHANGE1	;  
000000A3 42 66               B       98 	OR	R6,R6
000000A5 EB F4               B       99 	JR	NZ,$LOOP	;    ?
000000A7 8B 0F               B      100 	JR	$TEST2	; 
000000A9                     B      101 $CHANGE1:
000000A9 66 E4 80            B      102 	TCM	R4,#80H	;   
000000AC 6B 05               B      103 	JR	Z,$PRES1
000000AE D6 01 1B            B      104 	CALL	UP1	;  1
000000B1 8B E8               B      105 	JR	$LOOP
000000B3                     B      106 $PRES1:
000000B3 D6 00 D1            B      107 	CALL	PRS1	;  1
000000B6 8B E3               B      108 	JR	$LOOP
                             B      109 ; -------------------------------------------------------------------
000000B8                     B      110 $TEST2:
000000B8 50 E8               B      111 	POP	R8
000000BA                     B      112 $LOOP2:
000000BA 8E                  B      113 	INC	R8	;  + 1
000000BB E0 E5               B      114 	RR	R5	;   
000000BD CF                  B      115 	RCF
000000BE C0 E7               B      116 	RRC	R7
000000C0 7B 05               B      117 	JR	C,$CHANGE2	;  
000000C2 42 77               B      118 	OR	R7,R7
000000C4 EB F4               B      119 	JR	NZ,$LOOP2	;    ?
000000C6 AF                  B      120 	RET
000000C7                     B      121 $CHANGE2:
000000C7 66 E5 80            B      122 	TCM	R5,#80H	;   
000000CA EB EE               B      123 	JR	NZ,$LOOP2
000000CC D6 00 F2            B      124 	CALL	PRS2	;  2
000000CF 8B E9               B      125 	JR	$LOOP2
                             B      126 ; -------------------------------------------------------------------
                             B      127 ; *******************************************************************
                             B      128 ;   
                             B      129 ; INPUT	R8	 
                             B      130 ; *******************************************************************
000000D1                     B      131 PRS1:
                             B      132 	SCOPE
000000D1 C7 A8 40            B      133 	LD	R10,DBASE(R8)
000000D4 66 EA 20            B      134 	TCM	R10,#20H	;   ?
000000D7 6B 18               B      135 	JR	Z,$EXIT
000000D9 D6 01 A4            B      136 	CALL	CREAT_FIFO	; R10 =   
000000DC 7B 13               B      137 	JR	C,$EXIT
000000DE D7 8A 20            B      138 	LD	NUM(R10),R8	;  
000000E1 B0 E9               B      139 	CLR	R9
000000E3 D7 9A 2A            B      140 	LD	TIME(R10),R9	;  = 0
000000E6 9C 20               B      141 	LD	R9,#20H
000000E8 D7 9A 34            B      142 	LD	FLAG_S(R10),R9	;  
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    5


SCANER.S

Location Object              Type  Line Source
000000EB 46 EA 20            B      143 	OR	R10,#20H	;  
000000EE D7 A8 40            B      144 	LD	DBASE(R8),R10	;   
000000F1                     B      145 $EXIT:
000000F1 AF                  B      146 	RET
                             B      147 
000000F2                     B      148 PRS2:
                             B      149 	SCOPE
000000F2 C7 A8 40            B      150 	LD	R10,DBASE(R8)
000000F5 66 EA 20            B      151 	TCM	R10,#20H	;   ?
000000F8 EB 20               B      152 	JR	NZ,$EXIT
000000FA 66 EA 40            B      153 	TCM	R10,#40H	;   ?
000000FD 6B 1B               B      154 	JR	Z,$EXIT
                             B      155 
000000FF 46 EA 40            B      156 	OR	R10,#40H	;  
00000102 D7 A8 40            B      157 	LD	DBASE(R8),R10
00000105 56 EA 0F            B      158 	AND	R10,#0FH	;   
00000108 C7 BA 34            B      159 	LD	R11,FLAG_S(R10)
0000010B 46 EB 40            B      160 	OR	R11,#40H	;  
0000010E D7 BA 34            B      161 	LD	FLAG_S(R10),R11
00000111 C7 BA 2A            B      162 	LD	R11,TIME(R10)	; 
00000114 46 EB 80            B      163 	OR	R11,#80H	;  
00000117 D7 BA 2A            B      164 	LD	TIME(R10),R11
0000011A                     B      165 $EXIT:
0000011A AF                  B      166 	RET
                             B      167 
0000011B                     B      168 UP1:
                             B      169 	SCOPE
0000011B C7 A8 40            B      170 	LD	R10,DBASE(R8)
0000011E 66 EA 20            B      171 	TCM	R10,#20H	;   ?
00000121 EB 17               B      172 	JR	NZ,$EXIT
00000123 66 EA 40            B      173 	TCM	R10,#40H	;   ?
00000126 EB 13               B      174 	JR	NZ,$EXIT2
                             B      175 
00000128 46 EA 80            B      176 	OR	R10,#80H	;  
0000012B D7 A8 40            B      177 	LD	DBASE(R8),R10
0000012E 56 EA 0F            B      178 	AND	R10,#0FH	;   
00000131 C7 BA 34            B      179 	LD	R11,FLAG_S(R10)
00000134 46 EB 80            B      180 	OR	R11,#80H	;  
00000137 D7 BA 34            B      181 	LD	FLAG_S(R10),R11
0000013A                     B      182 $EXIT:
0000013A AF                  B      183 	RET
                             B      184 
0000013B                     B      185 $EXIT2:
0000013B B0 E9               B      186 	CLR	R9
0000013D D7 98 40            B      187 	LD	DBASE(R8),R9	;  
00000140 56 EA 0F            B      188 	AND	R10,#0FH
00000143 D6 01 B4            B      189 	CALL	CLR_FIFO
00000146 AF                  B      190 	RET
                             B      191 
                             B      192 ; *******************************************************************
                             B      193 ;	    
                             B      194 ; *******************************************************************
                             B      195 ;
                             B      196 OPEN_DRAIN:	MACRO
                             B      197 	OR	PR1,#%7F	; B   (7F)
                             B      198 	LD	PR2,#%FF	; C   (FF)
                             B      199 	LD	P01M,#00000100B ;P0-OUTPUT
                             B      200 	LD	PR0,#%FF	; K   (FF)
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    6


SCANER.S

Location Object              Type  Line Source
                             B      201 	LD	P01M,#01000101B ;P0-INPUT, P1-OUTPUT, INTERNAL STACK
                             B      202 	ENDMAC
                             B      203 
                             B      204 ; *******************************************************************
                             B      205 ;	    
                             B      206 ; *******************************************************************
                             B      207 
00000147                     B      208 SCAN_MATRIX:
                             B      209 	SCOPE
00000147 20 7F               B      210 	INC	LINE		;  
00000149 90 80               B      211 	RL	MASK		;  
0000014B 5B 08               B      212 	JR	MI,$NO_END_L	; 0  7 
0000014D E6 80 FE            B      213 	LD	MASK,#11111110B ;  
00000150 B0 7F               B      214 	CLR	LINE		;  
00000152 D6 01 79            B      215 	CALL	PLUS_FIFO	;    + 1
00000155                     B      216 $NO_END_L:
                             B      217 				;  
                             B      218 	OPEN_DRAIN		;    OPEN DRAIN
00000155 46 E1 7F            B+     218 	OR	PR1,#%7F	; B   (7F)
00000158 2C FF               B+     218 	LD	PR2,#%FF	; C   (FF)
0000015A E6 F8 04            B+     218 	LD	P01M,#00000100B ;P0-OUTPUT
0000015D 0C FF               B+     218 	LD	PR0,#%FF	; K   (FF)
0000015F E6 F8 45            B+     218 	LD	P01M,#01000101B ;P0-INPUT, P1-OUTPUT, INTERNAL STACK
00000162 54 80 E1            B      219 	AND	PR1,MASK	;  B   (0)
00000165 48 E0               B      220 	LD	R4,PR0
                             B      221 	OPEN_DRAIN		;    OPEN DRAIN
00000167 46 E1 7F            B+     221 	OR	PR1,#%7F	; B   (7F)
0000016A 2C FF               B+     221 	LD	PR2,#%FF	; C   (FF)
0000016C E6 F8 04            B+     221 	LD	P01M,#00000100B ;P0-OUTPUT
0000016F 0C FF               B+     221 	LD	PR0,#%FF	; K   (FF)
00000171 E6 F8 45            B+     221 	LD	P01M,#01000101B ;P0-INPUT, P1-OUTPUT, INTERNAL STACK
00000174 28 80               B      222 	LD	PR2,MASK	;  C   (0)
00000176 58 E0               B      223 	LD	R5,PR0	;  
00000178 AF                  B      224 	RET
                             B      225 ; *******************************************************************
                             B      226 ;   
                             B      227 ; *******************************************************************
                             B      228 	SCOPE
00000179                     B      229 PLUS_FIFO:
00000179 9C 0A               B      230 	LD	R9,#FIFO_S
0000017B                     B      231 $LOOP:
0000017B C7 B9 33            B      232 	LD	R11,FLAG_S-1(R9)
0000017E 66 EB 10            B      233 	TCM	R11,#10H	;    
00000181 EB 12               B      234 	JR	NZ,$NOT
00000183 C7 A9 1F            B      235 	LD	R10,NUM-1(R9)
00000186 B0 EB               B      236 	CLR	R11
00000188 D7 BA 40            B      237 	LD	DBASE(R10),R11	;    
0000018B A8 E9               B      238 	LD	R10,R9
0000018D 00 EA               B      239 	DEC	R10
0000018F D6 01 B4            B      240 	CALL	CLR_FIFO
00000192 9A E7               B      241 	DJNZ	R9,$LOOP
00000194 AF                  B      242 	RET
00000195                     B      243 $NOT:
00000195 C7 B9 29            B      244 	LD	R11,TIME-1(R9)	; 
00000198 A6 EB 7F            B      245 	CP	R11,#07FH
0000019B FB 04               B      246 	JR	NC,$EOF
0000019D BE                  B      247 	INC	R11
0000019E D7 B9 29            B      248 	LD	TIME-1(R9),R11	; 
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    7


SCANER.S

Location Object              Type  Line Source
000001A1                     B      249 $EOF:
000001A1 9A D8               B      250 	DJNZ	R9,$LOOP
000001A3 AF                  B      251 	RET
                             B      252 ; *******************************************************************
                             B      253 ;   
                             B      254 ; *******************************************************************
                             B      255 	SCOPE
000001A4                     B      256 CREAT_FIFO:
000001A4 A8 3E               B      257 	LD	R10,FREE	;   
000001A6 A6 EA 0A            B      258 	CP	R10,#FIFO_S
000001A9 6B 07               B      259 	JR	Z,$EOF
000001AB C7 BA 34            B      260 	LD	R11,FLAG_S(R10)	;   
000001AE B9 3E               B      261 	LD	FREE,R11	;   
000001B0 CF                  B      262 	RCF
000001B1 AF                  B      263 	RET
000001B2                     B      264 $EOF:
000001B2 DF                  B      265 	SCF
000001B3 AF                  B      266 	RET
                             B      267 ; *******************************************************************
                             B      268 ;  
                             B      269 ; *******************************************************************
000001B4                     B      270 CLR_FIFO:
                             B      271 	SCOPE
000001B4 B8 3E               B      272 	LD	R11,FREE	;   
000001B6 D7 BA 34            B      273 	LD	FLAG_S(R10),R11
000001B9 A9 3E               B      274 	LD	FREE,R10	;   
000001BB B0 EB               B      275 	CLR	R11
000001BD D7 BA 20            B      276 	LD	NUM(R10),R11
000001C0 D7 BA 2A            B      277 	LD	TIME(R10),R11
000001C3 AF                  B      278 	RET
                             A        8 	INCLUDE "ADC.S"
                             B        1 ;ADC 3
                             B        2 ; HEADER
                             B        3 ; *******************************************************************
                             B        4 ;  3  
                             B        5 ; *******************************************************************
                   P3        B        6 P_ANSEL	EQU	P3
                   00000002  B        7 HIST	EQU	2	; 
                   00000010  B        8 REF	EQU	00010000B
                   P3        B        9 PORTREF	EQU	P3
                             B       10 ; *******************************************************************
                             B       11 
                             B       12 	SEGMENT	IDATA
00000081                     B       13 AN_SEL:	DS	1	;   
00000082                     B       14 U:	DS	4	;   
00000086                     B       15 UL:	DS	4	;   
0000008A                     B       16 FL:	DS	4	;  
                             B       17 			; F+3   
0000008E                     B       18 K_SH:	DS	1	;   
0000008F                     B       19 K_F:	DS	1	;  
                             B       20 	SEGMENT	ICODE
                             B       21 ; *******************************************************************
                             B       22 ; .      3
                             B       23 ; *******************************************************************
000001C4                     B       24 ADC3_INIT:
                             B       25 ;  
                             B       26 ; -------------------------------------------------------------------
000001C4 E6 F3 08            B       27 	LD	PRE1,#08H	; DIVIDE BY TWO, ONE-SHOT MODE, T IN MODE
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    8


ADC.S

Location Object              Type  Line Source
000001C7 46 F1 10            B       28 	OR	TMR,#10H	; GATE INPUT
                             B       29 ;    3
                             B       30 ; -------------------------------------------------------------------
000001CA 46 03 10            B       31 	OR	PORTREF,#REF	; DISCHARGE CAP
000001CD E6 81 03            B       32 	LD	AN_SEL,#3	;   = 3
000001D0 46 03 60            B       33 	OR	P_ANSEL,#01100000B ;   
                             B       34 ;  
                             B       35 ; -------------------------------------------------------------------
000001D3 B0 8F               B       36 	CLR	K_F	;  
000001D5 B0 8E               B       37 	CLR	K_SH	;  
000001D7 B0 8D               B       38 	CLR	FL+3	;   
000001D9 46 FB 08            B       39 	OR	IMR,#00001000B	;    
000001DC AF                  B       40 	RET
                             B       41 ; *******************************************************************
                             B       42 ;       
                             B       43 ; *******************************************************************
000001DD                     B       44 ADC3:
000001DD 06 8D 10            B       45 	ADD	FL+3,#10H	;  
000001E0 A6 8D 80            B       46 	CP	FL+3,#80H	;   
000001E3 6D 02 4E            B       47 	JP	Z,ADC_START
000001E6 A6 8D 00            B       48 	CP	FL+3,#0
000001E9 EB 62               B       49 	JR	NZ,$EXIT
                             B       50 
000001EB D6 02 5D            B       51 	CALL	ADC_READ
000001EE 7B 5D               B       52 	JR	C,$EXIT
000001F0 B0 E5               B       53 	CLR	R5
000001F2 88 81               B       54 	LD	R8,AN_SEL	;  
000001F4 A6 E8 03            B       55 	CP	R8,#3		;  
000001F7 6B 15               B       56 	JR	Z,$CALIBRATE
                             B       57 
000001F9 24 85 E4            B       58 	SUB	R4,U+3		;   
000001FC C7 68 82            B       59 	LD	R6,U(R8)	;  
000001FF C7 78 86            B       60 	LD	R7,UL(R8)
00000202 22 57               B       61 	SUB	R5,R7		; 
00000204 32 46               B       62 	SBC	R4,R6
                             B       63 
00000206 D0 E4               B       64 	SRA	R4
00000208 C0 E5               B       65 	RRC	R5		;  / 2
                             B       66 
0000020A 02 57               B       67 	ADD	R5,R7
0000020C 12 46               B       68 	ADC	R4,R6		;   
                             B       69 
0000020E                     B       70 $CALIBRATE:
0000020E D7 48 82            B       71 	LD	U(R8),R4	;  
00000211 D7 58 86            B       72 	LD	UL(R8),R5	;  
                             B       73 
00000214                     B       74 $LOVER:
                             B       75 ;  
                             B       76 ; -------------------------------------------------------------------
00000214                     B       77 KEYS3:
00000214 68 02               B       78 	LD	R6,P2		;  P2
00000216 48 8E               B       79 	LD	R4,K_SH		;  
00000218 10 E6               B       80 	RLC	R6		;  
0000021A EF                  B       81 	CCF			; 
0000021B C0 E4               B       82 	RRC	R4		;   
0000021D 49 8E               B       83 	LD	K_SH,R4		; 
0000021F A6 E8 03            B       84 	CP	R8,#3
00000222 EB 13               B       85 	JR	NZ,$NO_TREE
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:    9


ADC.S

Location Object              Type  Line Source
00000224 68 8F               B       86 	LD	R6,K_F
00000226 F0 E4               B       87 	SWAP	R4
00000228 56 E4 0F            B       88 	AND	R4,#0FH
0000022B 56 E6 0F            B       89 	AND	R6,#0FH		;  
0000022E A2 46               B       90 	CP	R4,R6
00000230 6B 05               B       91 	JR	Z,$NO_TREE	;  
00000232 46 E4 80            B       92 	OR	R4,#80H		;  
00000235 49 8F               B       93 	LD	K_F,R4
                             B       94 ;    
                             B       95 ; -------------------------------------------------------------------
00000237                     B       96 $NO_TREE:
00000237 8E                  B       97 	INC	R8
00000238 56 E8 03            B       98 	AND	R8,#3		;  
0000023B 89 81               B       99 	LD	AN_SEL,R8
0000023D F0 E8               B      100 	SWAP	R8
0000023F 90 E8               B      101 	RL	R8
00000241 56 E8 60            B      102 	AND	R8,#01100000B 	; 
00000244 56 03 9F            B      103 	AND	P_ANSEL,#10011111B ;  
00000247 44 E8 03            B      104 	OR	P_ANSEL,R8	;   
                             B      105 ;  
0000024A 46 03 10            B      106 	OR	PORTREF,#REF	; DISCHARGE CAP
0000024D                     B      107 $EXIT:
0000024D AF                  B      108 	RET
                             B      109 ; ADC
                             B      110 ; *******************************************************************
                             B      111 ; 	ADC USING RC-GENERATED RAMP
                             B      112 ; *******************************************************************
                   R4        B      113 RESULT	EQU	R4
                   R5        B      114 DELAY	EQU	R5
                   00000004  B      115 IRQ2	EQU	4
                             B      116 ; *******************************************************************
                             B      117 	SCOPE
0000024E                     B      118 ADC_START: 
0000024E 46 03 10            B      119 	OR	PORTREF,#REF	; DISCHARGE CAP
00000251 B0 F2               B      120 	CLR	T1		; RESET T1 (END)
00000253 56 FA FB            B      121 	AND	IRQ,#255-IRQ2 	; CLEAR IORQ 
00000256 56 03 EF            B      122 	AND	PORTREF,#(255-REF) ; TAKE P20 LOW (START RAMP)
00000259 46 F1 0C            B      123 	OR	TMR,#0CH	; LOAD AND START TIMER
0000025C AF                  B      124 	RET
                             B      125 
                             B      126 ; *******************************************************************
                             B      127 ; INPUT	
                             B      128 ; OUTPUT	RESULT	=
                             B      129 ; OUTPUT	CF	=ERROR
                             B      130 ; *******************************************************************
0000025D                     B      131 ADC_READ:
0000025D 76 FA 04            B      132 	TM	IRQ,#IRQ2
00000260 EB 02               B      133 	JR	NZ,$READY	;  
00000262 DF                  B      134 	SCF			;  
00000263 AF                  B      135 	RET
00000264                     B      136 $READY:
00000264 48 F2               B      137 	LD	RESULT,T1	; 
                             B      138 ;	COM	RESULT		;  
00000266 46 03 10            B      139 	OR	PORTREF,#REF	; DISCHARGE CAP
00000269 CF                  B      140 	RCF
0000026A AF                  B      141 	RET
                             B      142 ; *******************************************************************
                             B      143 ;   	
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   10


ADC.S

Location Object              Type  Line Source
                             B      144 ; *******************************************************************
0000026B                     B      145 INT3:
0000026B 60 8A               B      146 	COM	FL
0000026D 60 8B               B      147 	COM	FL+1
0000026F 60 8C               B      148 	COM	FL+2
00000271 BF                  B      149 	IRET
                             A        9 	INCLUDE "UART.S"
                             B        1 ; SERIAL
                             B        2 ; HEADER
                             B        3 ; *******************************************************************
                             B        4 ;OUTPUT	INDATA,INDATA1	 	 
                             B        5 ;INPUT 	BCNT		 
                             B        6 ; *******************************************************************
                             B        7 ; PORT 3:       BIT 7 = SERIAL OUT
                             B        8 
                   00000000  B        9 RG_SCC	EQU	0	;   
                             B       10 
                   R12       B       11 BITCOUNT	EQU	R12	;  
                   0000000C  B       12 BITCOUNTM	EQU	12	;  
                   R13       B       13 TXDATA	EQU   	R13	;  
                   R14       B       14 TXDATA1	EQU	R14	;  	
                   R15       B       15 TXDATA2	EQU	R15	;  
                             B       16 ;
                             B       17 ; *******************************************************************
                             B       18 ;  
                             B       19 ; *******************************************************************
                             B       20 	SCOPE
00000272                     B       21 SER_INIT:
                             B       22 ;	SERIAL BAUDRATE, USE T0 FOR TIMING
                             B       23 ; -------------------------------------------------------------------
00000272 8F                  B       24 	DI
                             B       25 ; -------------------------------------------------------------------
                             B       26 ;	LD	T0,#104	; BAUD RATE = 4800
                             B       27 ;	LD	PRE0,#00010001B ; PRESCALER VALUE 4
                             B       28 ; -------------------------------------------------------------------
00000273 E6 F4 A0            B       29 	LD	T0,#160	; BAUD RATE = 3125 (KDIV = 2560)
00000276 E6 F5 11            B       30 	LD	PRE0,#00010001B ; PRESCALER VALUE 4 (FOR K DIV 2560)
                             B       31 ; -------------------------------------------------------------------
00000279 46 F1 03            B       32 	OR	TMR,#%03	; LOAD + ENABLE T0
                             B       33 
0000027C 46 FB 10            B       34 	OR	IMR,#00010000B ;T0 INTERRUPT ON
0000027F 56 FA EF            B       35 	AND	IRQ,#11101111B ;T0 IRQ RESET
                             B       36 
00000282 46 03 80            B       37 	OR	P3,#80H	;  TXT  1
                             B       38 ;   
                             B       39 ; -------------------------------------------------------------------
00000285 B0 EC               B       40 	CLR	BITCOUNT
00000287 B0 ED               B       41 	CLR	TXDATA
00000289 B0 EE               B       42 	CLR	TXDATA1
0000028B B0 EF               B       43 	CLR	TXDATA2
0000028D AF                  B       44 	RET
                             B       45 	
                             B       46 ; *******************************************************************
                             B       47 ; INPUT	R4 R5 	
                             B       48 ; OUTPUT	CF	ERROR
                             B       49 ; *******************************************************************
                             B       50 	SCOPE
0000028E                     B       51 SEND_2BYTE:
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   11


UART.S

Location Object              Type  Line Source
0000028E                     B       52 $LOOP:
0000028E A6 0C 00            B       53 	CP	BITCOUNTM,#0
00000291 EB FB               B       54 	JR	NZ,$LOOP
                             B       55 
00000293 3C FF               B       56 	LD	R3,#0FFH
00000295 CF                  B       57 	RCF
00000296 10 E2               B       58 	RLC	R2
00000298 10 E3               B       59 	RLC	R3	;   2
0000029A DF                  B       60 	SCF
0000029B 10 E2               B       61 	RLC	R2
0000029D 10 E3               B       62 	RLC	R3	;   1
0000029F CF                  B       63 	RCF
000002A0 10 E1               B       64 	RLC	R1
000002A2 10 E2               B       65 	RLC	R2
000002A4 10 E3               B       66 	RLC	R3	;   1
000002A6 DF                  B       67 	SCF
000002A7 10 E1               B       68 	RLC	R1
000002A9 10 E2               B       69 	RLC	R2
000002AB 10 E3               B       70 	RLC	R3	;  
                             B       71 
000002AD 19 0D               B       72 	LD	13+RG_SCC,R1
000002AF 29 0E               B       73 	LD	14+RG_SCC,R2
000002B1 39 0F               B       74 	LD	15+RG_SCC,R3
000002B3 E6 0C 15            B       75 	LD	12+RG_SCC,#21 ; "1"+STR+BYTE+STP+STR+BYTE+STP	
000002B6 CF                  B       76 	RCF
000002B7 AF                  B       77 	RET
                             B       78 ; *******************************************************************
                             B       79 ;	TRANSMIT T0 INTERRUPT HANDLER
                             B       80 ;	FOR  BIT GENERATION TO P3,7
                             B       81 ; *******************************************************************
                             B       82 	SCOPE
000002B8                     B       83 T0_INT:
                             B       84 	IF	TEST		;<<<<<<<<<<<<<<<<<
                             B       85 		AND	P1,#7FH	;<<<<<<<<<<<<<<<<<
                             B       86 	ENDIF			;<<<<<<<<<<<<<<<<<
                             B       87 
000002B8 70 FD               B       88 	PUSH	RP
000002BA E6 FD 00            B       89 	LD	RP,#RG_SCC
000002BD A6 EC 00            B       90 	CP	BITCOUNT,#0
000002C0 6B 1D               B       91 	JR	Z,$NEXT2	;   /10-12/
000002C2 C0 EF               B       92 	RRC	TXDATA2		; /6/
000002C4 C0 EE               B       93 	RRC	TXDATA1		; /6/
000002C6 C0 ED               B       94 	RRC	TXDATA		; /6/ SHIFT BIT
000002C8 7B 05               B       95 	JR	C,$SER_O_1	; /10-12/ BIT = 1
000002CA 56 E3 7F            B       96 	AND	R3,#%7F		; /6/ BIT = 0 
000002CD 8B 05               B       97 	JR	$NEXT		; /10/
000002CF                     B       98 $SER_O_1:
000002CF 46 E3 80            B       99 	OR	R3,#%80		; BIT = 1 /6/
000002D2 8B 00               B      100 	JR	$NEXT		;    /10/
000002D4                     B      101 $NEXT:
000002D4 00 EC               B      102 	DEC	BITCOUNT	; BIT CNT DOWN /6/
000002D6 D6 01 DD            B      103 	CALL	ADC3		;  
000002D9 D6 00 7A            B      104 	CALL	SCANER		;  
000002DC 50 FD               B      105 	POP	RP
                             B      106 
                             B      107 	IF	TEST		;<<<<<<<<<<<<<<<
                             B      108 		OR	P1,#80H	;<<<<<<<<<<<<<<<
                             B      109 	ENDIF			;<<<<<<<<<<<<<<<
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   12


UART.S

Location Object              Type  Line Source
                             B      110 
000002DE BF                  B      111 	IRET
000002DF                     B      112 $NEXT2:
000002DF FF                  B      113 	NOP			;  48 
000002E0 FF                  B      114 	NOP
000002E1 FF                  B      115 	NOP
000002E2 FF                  B      116 	NOP
000002E3 FF                  B      117 	NOP
000002E4 FF                  B      118 	NOP
000002E5 FF                  B      119 	NOP
000002E6 FF                  B      120 	NOP
000002E7 D6 01 DD            B      121 	CALL	ADC3		;  
000002EA D6 00 7A            B      122 	CALL	SCANER		;  
000002ED 50 FD               B      123 	POP	RP
                             B      124 
                             B      125 	IF	TEST
                             B      126 		OR	P1,#80H		;<<<<<<<<<<<<<<<
                             B      127 	ENDIF
                             B      128 
000002EF BF                  B      129 	IRET
                             B      130 
                             A       10 	INCLUDE "MPRG.S"
                             B        1 ; SEARCH 2 SEND
                             B        2 ; HEADER
                             B        3 ; *******************************************************************
                             B        4 ;      
                             B        5 ; *******************************************************************
000002F0                     B        6 SRCH2SEND:
                             B        7 ; *******************************************************************
                             B        8 ;   
                             B        9 ; *******************************************************************
                             B       10 	SCOPE
000002F0 28 8F               B       11 	LD	R2,K_F
000002F2 66 E2 80            B       12 	TCM	R2,#80H		;   = 1 ?
000002F5 EB 08               B       13 	JR	NZ,$EXIT	; 
000002F7 1C 3F               B       14 	LD	R1,#63		;   
000002F9 56 8F 7F            B       15 	AND	K_F,#7FH	;   
000002FC D6 02 8E            B       16 	CALL	SEND_2BYTE
000002FF                     B       17 $EXIT:
                             B       18 ; *******************************************************************
                             B       19 ;   
                             B       20 ; *******************************************************************
                             B       21 	SCOPE
000002FF 28 82               B       22 	LD	R2,U
00000301 38 8A               B       23 	LD	R3,FL
00000303 22 32               B       24 	SUB	R3,R2
00000305 DB 03               B       25 	JR	PL,$PLUS
00000307 60 E3               B       26 	COM	R3
00000309 3E                  B       27 	INC	R3
0000030A                     B       28 $PLUS:
0000030A A6 E3 02            B       29 	CP	R3,#HIST
0000030D 7B 0C               B       30 	JR	C,$NO_CHANGE0
0000030F 29 8A               B       31 	LD	FL,R2
00000311 C0 E2               B       32 	RRC	R2	;   2
00000313 46 E2 80            B       33 	OR	R2,#80H	;   2
00000316 1C 3C               B       34 	LD	R1,#60	;  .  0
00000318 D6 02 8E            B       35 	CALL	SEND_2BYTE
0000031B                     B       36 $NO_CHANGE0:
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   13


MPRG.S

Location Object              Type  Line Source
0000031B 28 83               B       37 	LD	R2,U+1
0000031D 38 8B               B       38 	LD	R3,FL+1
0000031F 22 32               B       39 	SUB	R3,R2
00000321 DB 03               B       40 	JR	PL,$PLUS1
00000323 60 E3               B       41 	COM	R3
00000325 3E                  B       42 	INC	R3
00000326                     B       43 $PLUS1:
00000326 A6 E3 02            B       44 	CP	R3,#HIST
00000329 7B 0C               B       45 	JR	C,$NO_CHANGE1
0000032B 29 8B               B       46 	LD	FL+1,R2
0000032D C0 E2               B       47 	RRC	R2	;   2
0000032F 46 E2 80            B       48 	OR	R2,#80H	;   2
00000332 1C 3D               B       49 	LD	R1,#61	;  .  1
00000334 D6 02 8E            B       50 	CALL	SEND_2BYTE
00000337                     B       51 $NO_CHANGE1:
00000337 28 84               B       52 	LD	R2,U+2
00000339 38 8C               B       53 	LD	R3,FL+2
0000033B 22 32               B       54 	SUB	R3,R2
0000033D DB 03               B       55 	JR	PL,$PLUS2
0000033F 60 E3               B       56 	COM	R3
00000341 3E                  B       57 	INC	R3
00000342                     B       58 $PLUS2:
00000342 A6 E3 02            B       59 	CP	R3,#HIST
00000345 7B 0C               B       60 	JR	C,$EXIT
00000347 29 8C               B       61 	LD	FL+2,R2
00000349 C0 E2               B       62 	RRC	R2	;   2
0000034B 46 E2 80            B       63 	OR	R2,#80H	;   2
0000034E 1C 3E               B       64 	LD	R1,#62	;  .  2
00000350 D6 02 8E            B       65 	CALL	SEND_2BYTE
00000353                     B       66 $EXIT:
                             B       67 ; *******************************************************************
                             B       68 ;  
                             B       69 ; *******************************************************************
                             B       70 	SCOPE
00000353                     B       71 SEND_FIFO:
00000353 0C 0A               B       72 	LD	R0,#FIFO_S
00000355                     B       73 $LOOP:
00000355 C7 30 33            B       74 	LD	R3,FLAG_S-1(R0)
00000358 76 E3 C0            B       75 	TM	R3,#0C0H	;  - ?
0000035B 6B 19               B       76 	JR	Z,$NOT
0000035D C7 10 1F            B       77 	LD	R1,NUM-1(R0)	;  
00000360 C7 20 29            B       78 	LD	R2,TIME-1(R0)	;  
                             B       79 
00000363 66 E3 80            B       80 	TCM	R3,#80H		; . =1  
00000366 EB 11               B       81 	JR	NZ,$NO_UP
00000368 3C 30               B       82 	LD	R3,#30H		;    
0000036A D7 30 33            B       83 	LD	FLAG_S-1(R0),R3	;  
0000036D 46 E2 80            B       84 	OR	R2,#80H		;  2 
00000370 46 E1 40            B       85 	OR	R1,#40H		;  
00000373 D6 02 8E            B       86 	CALL	SEND_2BYTE
00000376                     B       87 $NOT:
00000376 0A DD               B       88 	DJNZ	R0,$LOOP
00000378 AF                  B       89 	RET
                             B       90 
00000379                     B       91 $NO_UP:
00000379 66 E3 40            B       92 	TCM	R3,#40H		; . =1  
0000037C EB F8               B       93 	JR	NZ,$NOT
0000037E 56 E3 BF            B       94 	AND	R3,#0BFH
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   14


MPRG.S

Location Object              Type  Line Source
00000381 D7 30 33            B       95 	LD	FLAG_S-1(R0),R3	;    
00000384 46 E2 80            B       96 	OR	R2,#80H		;  2 
00000387 D6 02 8E            B       97 	CALL	SEND_2BYTE
0000038A 0A C9               B       98 	DJNZ	R0,$LOOP
0000038C AF                  B       99 	RET
                             A       11 	END
                             A       12  
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   15


main.s

Symbol Name                      Value	  Section
ADC3                             000001DD ICODE
ADC3_INIT                        000001C4 ICODE
ADC_READ                         0000025D ICODE
ADC_START                        0000024E ICODE
AN_SEL                           00000081 IDATA
BITCOUNT                         R12 
BITCOUNTM                        0000000C 
CLR_FIFO                         000001B4 ICODE
CREAT_FIFO                       000001A4 ICODE
DBASE                            00000040 IDATA
DELAY                            R5 
DIE                              0000003E ICODE
DUMMY                            00000044 ICODE
FIFO_S                           0000000A 
FL                               0000008A IDATA
FLAG_S                           00000034 IDATA
FREE                             0000003E IDATA
HIST                             00000002 
ICODE                            00000000 ICODE
IDATA                            00000000 IDATA
INT3                             0000026B ICODE
IRQ2                             00000004 
K_F                              0000008F IDATA
K_SH                             0000008E IDATA
KEYS3                            00000214 ICODE
LINE                             0000007F IDATA
MAININIT                         00000045 ICODE
MASK                             00000080 IDATA
MX1                              00000071 IDATA
MX2                              00000078 IDATA
NUM                              00000020 IDATA
P_ANSEL                          P3 
PLUS_FIFO                        00000179 ICODE
PORTREF                          P3 
PR0                              R0 
PR1                              R1 
PR2                              R2 
PRS1                             000000D1 ICODE
PRS2                             000000F2 ICODE
REF                              00000010 
RESULT                           R4 
RG_MAIN                          00000010 
RG_SCC                           00000000 
SCAN_MATRIX                      00000147 ICODE
SCANER                           0000007A ICODE
SCANER_INIT                      00000050 ICODE
SEND_2BYTE                       0000028E ICODE
SEND_FIFO                        00000353 ICODE
SER_INIT                         00000272 ICODE
SP_MAIN                          000000EF 
SRCH2SEND                        000002F0 ICODE
START                            0000000C ICODE
T0_INT                           000002B8 ICODE
TEST                             00000000 
TESTK                            00000000 
TIME                             0000002A IDATA
TXDATA                           R13 
TXDATA1                          R14 
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   16


main.s

Symbol Name                      Value	  Section
TXDATA2                          R15 
U                                00000082 IDATA
UL                               00000086 IDATA
UP1                              0000011B ICODE

   62 Symbols.
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   17


main.s

Symbol Name                      References
ADC3                                44*  103   121 
ADC3_INIT                           79    24*
ADC_READ                            51   131*
ADC_START                           47   118*
AN_SEL                              13*   32    54    99 
BITCOUNT                            11*   40    90   102 
BITCOUNTM                           12*   53 
CLR_FIFO                           189   240   270*
CREAT_FIFO                         136   256*
DBASE                               20*   36   133   144   150   157   170 
                                   177   187   237 
DELAY                              114*
DIE                                 64*   67 
DUMMY                               16    17    18    21    71*
FIFO_S                              13*   14    15    16    47   230   258 
                                    72 
FL                                  16*   38    45    46    48   146   147 
                                   148    23    31    53    61 
FLAG_S                              16*   52   142   159   161   179   181 
                                   232   260   273    74    83    95 
FREE                                17*   55   257   261   272   274 
HIST                                 7*   29    44    59 
INT3                                19   145*
IRQ2                               115*  121   132 
K_F                                 19*   36    86    93    11    15 
K_SH                                18*   37    79    83 
KEYS3                               77*
LINE                                24*   56    69   210   214 
MAININIT                            62    75*
MASK                                25*   57   211   213   219   222 
MX1                                 21*   42    70    80 
MX2                                 22*   43    71    81 
NUM                                 14*   50   138   235   276    77 
P_ANSEL                              6*   33   103   104 
PLUS_FIFO                          215   229*
PORTREF                              9*   31   106   119   122   139 
PR0                                  6*  218   220   221   223 
PR1                                  7*  218   219   221 
PR2                                  8*  218   221   222 
PRS1                               107   131*
PRS2                               124   148*
REF                                  8*   31   106   119   122   139 
RESULT                             113*  137 
RG_MAIN                             27*   63 
RG_SCC                              26*   59     9*   72    73    74    75 
                                    89 
SCAN_MATRIX                         66   208*
SCANER                              64*  104   122 
SCANER_INIT                         80    31*
SEND_2BYTE                          51*   16    35    50    65    86    97 
SEND_FIFO                           71*
SER_INIT                            78    21*
SP_MAIN                             31*   61 
SRCH2SEND                           66     6*
START                               35*
T0_INT                              20    83*
TEST                                 3*   84   107   125 
TESTK                                4*   73 
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   18


main.s

Symbol Name                      References
TIME                                15*   51   140   162   164   244   248 
                                   277    78 
TXDATA                              13*   41    94 
TXDATA1                             14*   42    93 
TXDATA2                             15*   43    92 
U                                   14*   58    59    71    22    37    52 
UL                                  15*   60    72 
UP1                                104   168*
Zilog Macro Assembler.  Version 2.00    30-Jul-98    11:21:39   Page:   19


main.s


    0 Warnings
    0 Errors
